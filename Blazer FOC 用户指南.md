# Blazer FOC 用户指南

First update:2024.8

Last update:2024.11



## 前言

​		无刷电机广泛应用于机器人领域，相比直流有刷电机，具有结构简单，转矩大，响应快，精度高等优点。要实现优异的运动控制效果，不仅需要电机本身的特性足够良好，更取决于驱动器的性能。传统的方波电调操作简单，可兼容大部分电机，但难以做到细腻的控制效果，无法满足机器人的需求，使用了**FOC**（**field-oriented control**）的驱动，能够对电机进行力矩、速度和位置的三环控制，响应速度和控制精度都是传统电调无法比拟的。

​		Blazer FOC始于2023年，由西安交通大学**机器人俱乐部**（**Robocon**）提供研发支持，WJY完成初代版本的软硬件开发。研制该驱动的目的在于对现有的成品驱动实现自主化替代，降低使用门槛，并节省费用开销。目前已实现的大功率叠层版本（60A），针对适配的电机，可以完成有位置传感器的电流环、速度环和位置环。单板中功率已完成硬件设计，功能待测试。

## 一、功能介绍

### 1.已有功能

* 基础有感FOC算法 电流 速度 位置 可控
* 速度爬升
* 编码器偏移校准
* 磁编码器偏心补偿
* 电机电阻电感辨识
* OLED+按键离线操作
* CAN通信控制
* CAN心跳
* 支持绝对式SPI编码器 TLE5012B、MT6816
* 过压、欠压、过流、过温保护
* 编码器断连识别

### 2.尚待开发

* 更多可适配编码器
* 无位置传感器算法
* 速度规划
* 前馈控制
* 逆变器死区补偿
* USB通信协议
* Blazer FOC上位机

### 3.注意事项

> 驱动供电电压为**3S-6S**，外部电源超过30V可能会引发器件过压损坏。

> 请按照说明完成各项参数的配置及校准，错误设置将会导致电机不正常运行。

> **上电运行时**，保证上层控制板和下层功率板的紧密连接，上下层板脱离将会导致下层板烧毁。

> 驱动属于强电设备，使用时请按照说明正确配置，否则电机可能会出现失控跑飞的情况。

​		**驱动仍处于研发阶段，实际使用中可能存在一些问题，还请谅解。如遇明显失控的情况，可向开发者反馈**

## 二、硬件设计

### 1.元件选型

#### 1.1大功率叠层版本

* MCU : **STM32F405RGT6**

* 栅极驱动 : **FD6288Q**

* MOSFET : **HYG011N04LS1TA** 40V 320A

* 采样电阻 : **1mΩ** **3920**

* 电流感应放大器 : **INA240A1PWR**

* 采样方案：**三电阻相线采样**

* 屏幕 :  **0.78寸OLED SH1107**

### 2.整体布局

<center class="half">
    <img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Controller Top.png" width="200"/>
    <img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Controller Bottom.png" width="200"/>
</center>

<center class="half">
    <img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Driver Top.png" width="200"/>
    <img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Driver Bottom.png" width="200"/>
</center>
<img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Blazer-FOC.png" alt="Blazer-FOC" width="250;" />



## 二、软件设置

### 1.参数定义

|   名称   |   解释   |    范围     | 参数ID | 默认值 |
| :------: | :------: | :---------: | :----: | :------: |
| mode | 运行模式 | [0,8] (int) |  0x00  |    |
|  i_set   | 设定电流 |   [-i_lim,i_lim]   |  0x02  |    |
| spd_set  | 设定速度 |  [-spd_lim,spd_lim]  |  0x04  |    |
| pos_set  | 设定位置 |     [-$\infty$,+$\infty$]     | 0x06 |  |
| **id** | 修改节点ID | [0,7] (int) | 0x08 | 0 |
| **pol** | 极对数 | [2,30] (int) | 0x0A | 0 |
| **enc_type** | 编码器型号 | [0,1] (int) | 0x0C | 0 |
| **i_cal** | 校准电流 | [5,30] | 0x0E | 10 |
| **i_lim** | 最大电流 | [0,60] | 0x10 | 30 |
| **spd_lim** | 最大速度 | [0,400] | 0x12 | 200 |
| **acc** | 加速度 | [0,1000] | 0x14 | 50 |
| **dec** | 减速度 | [0,1000] | 0x16 | 50 |
| **spd_kp** | 速度环比例P | [0.01,2] | 0x18 | 0.05 |
| **spd_ki** | 速度环积分I | [0,2] | 0x1A | 0.5 |
| **pos_kp** | 位置环比例P | [0.01,1] | 0x1C | 0.1 |
| **pos_ki** | 位置环积分I | [0,1] | 0x1E | 0 |
| **can_hb** | CAN心跳 | [500,2000] | 0x20 | 500 |
| vbus | 母线电压 | [8,30] | 0x22 |  |
| ibus | 母线电流 | [-5,60] | 0x24 |  |
| ia | A相电流 | [-i_lim,i_lim] | 0x26 |  |
| ib | B相电流 | [-i_lim,i_lim] | 0x28 |  |
| ic | C相电流 | [-i_lim,i_lim] | 0x2A |  |
| id | 直轴电流 | [-0,+0] | 0x2C |  |
| iq | 交轴电流 | [0,i_lim] | 0x2E |  |
| spd_filt | 速度滤波值 | [-400,400] | 0x30 |  |
| enc_raw | 编码器原始值 | [0,CPR] (int) | 0x32 |  |
| temp | 驱动温度 | [0,120] (int) | 0x34 |  |
| error | 当前错误 | [0,10] (int) | 0x36 |  |

注释：

1.电流的单位是A，速度的单位是r/s（转/秒），位置的单位是r（转），加速度、减速度的单位是r/s$^2$(转/秒$^2$)，CAN心跳的单位是ms。

2.0x00-0x06为**运行参数**，0x08-0x20为**用户参数**，0x22-0x36为**状态参数**。

参数解释：

**运行参数**

* mode：运行模式。0：失能状态-电机释放 1：电流控制模式 2：速度控制模式 3：位置控制模式 4：校准电阻电感磁链 5：校准编码器偏移及偏心补偿 6：恢    			  复默认配置  7：保存当前配置  8：清除错误。

​		电机进入闭环控制前必须先校准编码器偏移，**更换编码器型号**、**编码器重新安装**、**磁铁重新安装**、**电机线序改变**，编码器偏移均需重新校准，否则电机将无法正常运行，可能会发生跑飞的情况，校准前务必确保电机处于==空载==状态。

​		1 2 3为闭环控制模式，其中2：速度控制模式 较为常用。

​		 修改用户参数后，想要实现下次上电直接使用 (掉电不丢失) ，需调用模式7进行保存。调用模式4 5 6后自动保存，无需重复调用模式7。

* i_set：设定电流，在电流控制模式下使用。
* spd_set：设定速度，机械转速，在速度控制模式下使用。
* pos_set：设定位置，在位置控制模式下使用。

------

**用户参数**

* id：修改当前节点ID。

* pol：设置极对数，请参阅电机的参数，或通过数转子上贴装的磁钢片$\div$2的方式确认极对数，请务必确保极对数的正确，否则将无法正常闭环，严重时会烧毁电机。

* enc_type：指定编码器型号，目前支持的有 0 TLE5012B  1 MT6816，编码器型号实际与设定不符将会报错。

* i_cal：校准电流，一般取电机额定电流的50%。

* i_lim：最大电流限制，是速度环输出的限幅值，i_lim越大，电机力矩越大。

* spd_lim：最大转速限制。

* acc：电机加速度，用于速度控制模式。

* dec：电机减速度，用于速度控制模式。acc或dec为0时，禁用速度爬升。

* spd_kp：速度环比例P。

* spd_ki：速度环积分I。

* pos_kp：位置环比例P。一般位置环仅使用比例控制即可。

* pos_ki：位置环积分I。

* can_hb：CAN心跳时间，驱动在模式1 2 3下超过设定时间没有收到CAN报文将失能电机。设置为0时，禁用此功能。

  ------

**状态参数**

* vbus：母线电压，过低或过高时，驱动进入校准和闭环将报错。

* ibus：母线电流。

* ia ib ic：A B C相电流。

* id：直轴电流，反映了电机的励磁大小。

* iq：交轴电流，反映了电机的转矩大小。

* spd_filt：当前电机速度的滤波值，机械转速。

* enc_raw：当前编码器的原始值，TLE5012B的CPR为32768，MT6816的CPR为16384。

* temp：驱动温度，温度超过100℃将会报错。

* error：当前错误。0：无错误 1：电流采样偏置错误 2：编码器错误 3：极对数错误 4：CAN断开连接 5：电阻过大 6：电感过大 7：过流 8：过压 9：欠压      10：高温。

### 2.CAN协议

​		Blazer FOC使用**扩展帧**进行CAN通信，帧ID由节点ID和参数ID组成，格式为

​                                                   **==ID段：节点ID<<8 | 参数ID  数据段：32位float==**

​		<u>写操作时参数ID为偶数</u>，数据段为需要设置的参数值。<u>读操作时相应的参数ID+1，为奇数</u>，此时不关心数据段(数据段无效)。**状态参数**仅可读，写入无效。	

​		例如：设置节点ID为0x02的驱动极对数为21，则ID段为 **0x20A**，数据段为**21** (float)。

​				    读取节点ID为0x02的驱动内部设置的极对数，则ID段为**0x20B**，驱动回传：ID段为**0x20B**，数据段为**21** (float)。	

​					读取节点ID为0x02的驱动当前母线电压，则ID段为**0x223**，驱动回传：ID段为**0x223**，数据段为**24.012**(float)

​		在实际发送数据段时，是将32位的float转变为一个uint32_t，再通过移位寄存的方式，赋给4个uint8_t，DLC长度为4个字节。注意，将float转换为uint32_t请勿使用强制类型转换，这会舍去符号和小数部分，丢失精度，以下示例是错误的：

> ```
> float current = 10.0f;
> uint32_t current_u32;
> current_u32 = (uint32_t)current;
> ```

​		请使用以下函数：

> ```
> uint32_t FloatToIntBit(float x)
> {
> 	uint32_t *pInt;
> 	pInt = (uint32_t*)(&x);
> 	return *pInt;
> }
> 
> current_u32= FloatToIntBit(current);
> ```

## 三、离线操作

​		Blazer FOC大功率版本板载了一块0.78寸的OLED屏幕，可用于参数的手动修改。

### 1.LED指示

​		控制板有两颗LED用于现象指示，<u>绿色指示当前模式，红色指示运行错误</u>。每隔5s进行一轮闪烁，闪烁次数对应模式或错误的编号。例如：当前处于速度控制(模式2)，则绿色LED每隔5s闪烁2次；当前出现CAN断开连接(错误4)，则红色LED每隔5s闪烁4次。

### 2.按键逻辑

​		离线配置使用两个按键进行事件的触发，上方按键为**key1**，下方按键为**key2**。每个按键均具有**短按**和**长按**两个操作方式。以下为不同操作方式对应的基本逻辑。

* **key1 短按**：菜单右移、对象自增

* **key1长按**：进入下一级页面

* **key2短按**：菜单左移、对象自减

* **key2长按**：退回上一级界面

<img src="E:\Robocon\图片\图片1.png" alt="图片1" width="200;" />

### 3.界面介绍

​		使用多级菜单的结构对不同功能进行访问，上电后的初始界面显示了当前的CAN ID和母线电压。

<img src="E:\Robocon\图片\图片2.png" alt="图片2" width="200;" />

​		<u>长按key1</u>后，进入二级界面。

<img src="E:\Robocon\图片\IMG_20240828_162212_edit_761457763416101.jpg" alt="IMG_20240828_162212_edit_761457763416101" width="200;" />

​		<u>短按key1</u>向右切换，<u>短按key2</u>向左切换，<u>长按key1</u>进入下一级界面，<u>长按key2</u>退回到上一级界面。

### 4.功能配置

#### 4.1校准编码器偏移

​		校准编码器偏移需进入**Calib**界面，<u>长按key1</u>进入，界面如下。

<img src="E:\Robocon\图片\IMG_20240828_162424_edit_761437429915583.jpg" alt="IMG_20240828_162424_edit_761437429915583" width="200;"  />

​		校准前必须确保电机处于==空载==状态，例如用于驱动舵轮时应把车架空校准，带载或堵转校准会显示成功，但实际大概率失败，后续的闭环将无法正常运行，电机有概率**暴走**。校准全过程需保证编码器的稳定连接。<u>短按key1</u>，开始校准，此时的现象是电机开始缓慢正转，一段时间后开始缓慢反转，界面如下。

<img src="E:\Robocon\图片\IMG_20240828_162521_edit_761423210531210.jpg" alt="IMG_20240828_162521_edit_761423210531210" width="200;" />

​		待电机完全停止后，界面显示校准成功，断电后重新启动即可正常使用。

<img src="E:\Robocon\图片\IMG_20240828_163157_edit_761539184863484.jpg" alt="IMG_20240828_163157_edit_761539184863484" width="200;" />

​		若校准过程出现错误，请参照错误类型进行问题排查。

<img src="E:\Robocon\图片\IMG_20240828_163332_edit_761621981833263.jpg" alt="IMG_20240828_163332_edit_761621981833263" width="200;" />

#### 4.2CAN ID修改

​		CAN ID修改功能需进入**setting**界面，<u>长按key1</u>进入，界面如下。

<img src="E:\Robocon\图片\IMG_20240828_163551_edit_761753781345222.jpg" alt="IMG_20240828_163551_edit_761753781345222" width="200;" />

​		再次<u>长按key1</u>，进入到下一级配置界面。屏幕显示当前的ID为0x02，此时若需要将其更改为0x04，先<u>长按key1</u>，此时数字两端出现箭头，表示可以进行更改，<u>短按key1</u> ID增大，<u>短按key2</u> ID减小，ID范围为0x00~0x07。<u>短按key1</u>两下后当前为0x04，此时再<u>长按key1</u>，箭头消失,此时参数已保存到flash，断电后重新启动即可。

<center class="half">
    <img src="E:\Robocon\图片\IMG_20240828_163645_edit_761896600206659.jpg" width="120"/>
    <img src="E:\Robocon\图片\IMG_20240828_163702_edit_761879471389995.jpg" width="120"/>
    <img src="E:\Robocon\图片\IMG_20240828_163719_edit_761863490621768.jpg" width="120"/>
    <img src="E:\Robocon\图片\IMG_20240828_163732_edit_761849112220728.jpg" width="120"/>
</center>












