# Blazer FOC 用户指南

First update:2024.8

Last update:2024.8



## 前言

​		无刷电机广泛应用于机器人领域，相比直流有刷电机，具有结构简单，转矩大，响应快，精度高等优点。要实现优异的运动控制效果，不仅需要电机本身的特性足够良好，更取决于驱动器的性能。传统的方波电调操作简单，可兼容大部分电机，但难以做到细腻的控制效果，很多情况下无法满足机器人的需求，使用了**FOC**（**field-oriented control**）的驱动，能够对电机进行力矩、速度和位置的三环控制，响应速度和控制精度都是传统电调无法比拟的。

​		Blazer FOC始于2023年，由西安交通大学**机器人俱乐部**（**Robocon**）提供研发支持，WJY完成初代版本的软硬件开发。研制该驱动的目的在于对现有的成品驱动实现自主化替代，降低使用门槛，并节省费用开销。目前已实现的大功率叠层版本（60A），针对适配的电机，可以完成有位置传感器的电流环、速度环和位置环。单板中功率已完成硬件设计，功能待测试。

## 一、功能介绍

### 1.已有功能

* 基础有感FOC算法 电流 速度 位置 可控

* 编码器零偏校准

* 电机极对数辨识

* 电机电阻电感辨识

* OLED+按键离线操作

* CAN通信控制

* 支持绝对式SPI编码器 TLE5012B、MT6816

* 过压、欠压保护

* 编码器断连识别

### 2.尚待开发

* 更多可适配编码器

* 无位置传感器算法

* 磁编码器偏心补偿

* 速度规划

* 前馈控制

* USB虚拟串口通信

* Blazer FOC上位机

### 3.注意事项

> 驱动供电电压为**3S-6S**，外部电源超过30V可能会引发器件过压损坏。

> **极对数辨识**功能对于超过**20对极**的电机可能产生误判，导致电机无法正常运行，因此最保险的方式是直接用CAN设置电机的极对数。

> **上电运行时**，保证上层控制板和下层功率板的紧密连接，上下层板脱离将会导致下层板烧毁。

> 驱动属于强电设备，使用时请按照说明正确配置，否则电机可能会出现失控跑飞的情况。

​		**驱动仍处于研发阶段，实际使用中可能存在一些问题，还请谅解。如遇明显失控的情况，可向开发者反馈**

## 二、硬件设计

### 1.元件选型

#### 1.1大功率叠层版本

* MCU : **STM32F405RGT6**

* 栅极驱动 : **FD6288Q**

* MOSFET : **HYG006N04LS1TA** 40V 600A 或 **HYG011N04LS1TA** 40V 320A

* 采样电阻 : **1mΩ** **3920**

* 电流感应放大器 : **INA240A1PWR**

* 采样方案：三电阻相线采样

* 屏幕 :  **0.78寸OLED SH1107**

#### 1.2中功率单层版本

* MCU：**STM32G474RET6**

* 栅极驱动：**DRV8323RSRGZR**

* MOSFET：**NTMFSC0D9N04CL**

* 采样电阻：**1mΩ** **2512**

* 采样方案：**三电阻低端采样**

### 2.整体布局

#### 2.1大功率叠层版本
<center class="half">
    <img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Driver Top.png" width="200"/>
    <img src="E:\Robocon\Project\Blazer-FOC\3_Model\image\Driver Bottom.png" width="200"/>
</center>

#### 2.2中功率单层版本
<center class="half">
    <img src="E:\Robocon\Project\BlazerFOC_Mini\3_Model\image\Mini Top.png" width="200"/>
    <img src="E:\Robocon\Project\BlazerFOC_Mini\3_Model\image\Mini Bottom.png" width="200"/>
</center>

<img src="E:\Robocon\Project\BlazerFOC_Mini\3_Model\image\Mini 3D.png" alt="Mini 3D" width="250;" />



## 二、软件设置



### 2.参数定义



|      |      |      |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |



### 3.CAN协议

​		Blazer FOC使用**扩展帧**进行CAN通信，帧ID由节点ID和参数ID组成，格式为

​                                                   **==ID段：节点ID<<8 | 参数ID  数据段：32位float==**



## 三、离线操作

​		Blazer FOC大功率版本板载了一块0.78寸的OLED屏幕，可用于进行一些离线配置，目前已支持的功能有编码器零偏校准、极对数辨识和CAN ID更改。

### 1.按键逻辑

​		离线配置使用两个按键进行事件的触发，上方按键为**key1**，下方按键为**key2**。每个按键均具有**短按**和**长按**两个操作方式。以下为不同操作方式对应的基本逻辑。

* **key1 短按**：菜单右移、对象自增

* **key1长按**：进入下一级页面

* **key2短按**：菜单左移、对象自减

* **key2长按**：退回上一级界面

<img src="E:\Robocon\图片\图片1.png" alt="图片1" width="200;" />

### 2.界面介绍

​		使用多级菜单的结构对不同功能进行访问，上电后的初始界面显示了当前的CAN ID和母线电压。

<img src="E:\Robocon\图片\图片2.png" alt="图片2" width="200;" />

​		<u>长按key1</u>后，进入二级界面。

<img src="E:\Robocon\图片\IMG_20240828_162212_edit_761457763416101.jpg" alt="IMG_20240828_162212_edit_761457763416101" width="200;" />

​		<u>短按key1</u>向右切换，<u>短按key2</u>向左切换，<u>长按key1</u>进入下一级界面，<u>长按key2</u>退回到上一级界面。

### 3.功能配置

#### 3.1编码器校准和极对数辨识

​		编码器校准和极对数辨识功能需进入**Calib**界面，<u>长按key1</u>进入，界面如下。

<img src="E:\Robocon\图片\IMG_20240828_162424_edit_761437429915583.jpg" alt="IMG_20240828_162424_edit_761437429915583" width="200;"  />

​		校准前必须确保电机处于==空载状态==，例如用于驱动舵轮时应把车架空校准，带载或堵转校准会显示成功，但实际大概率失败，后续的闭环将无法正常运行，电机有概率**暴走**。<u>短按key1</u>，开始校准，此时的现象是电机开始缓慢正转，一段时间后开始缓慢反转，绿色指示灯不断闪烁，界面如下。

<img src="E:\Robocon\图片\IMG_20240828_162521_edit_761423210531210.jpg" alt="IMG_20240828_162521_edit_761423210531210" width="200;" />

​		校准完成后，正常的现象是屏幕显示**Succeed！**，此时校准的参数已经保存至flash，断电后重新启动即可正常使用。

<img src="E:\Robocon\图片\IMG_20240828_163157_edit_761539184863484.jpg" alt="IMG_20240828_163157_edit_761539184863484" width="200;" />

​		若刚开始校准就显示**Failed!**，说明电流采样出现问题，请检查驱动板的三个**INA240A1PWR焊接是否良好**。若校准结束后显示**Failed!**，说明编码器读取异常，请检查（1）**编码器型号是否匹配**（2）**编码器线序是否正常**（3）**编码器接触是否良好**

<img src="E:\Robocon\图片\IMG_20240828_163332_edit_761621981833263.jpg" alt="IMG_20240828_163332_edit_761621981833263" width="200;" />

​		此校准将极对数一同进行辨识，但实际测试显示，对于超过20对极的电机，可能会出现误判的情况，因此多对极的电机建议用CAN手动配置极对数。

#### 3.2CAN ID修改

​		CAN ID修改功能需进入**setting**界面，<u>长按key1</u>进入，界面如下。

<img src="E:\Robocon\图片\IMG_20240828_163551_edit_761753781345222.jpg" alt="IMG_20240828_163551_edit_761753781345222" width="200;" />

​		再次<u>长按key1</u>，进入到下一级配置界面。屏幕显示当前的ID为0x02，此时若需要将其更改为0x04，先<u>长按key1</u>，此时数字两端出现箭头，表示可以进行更改，<u>短按key1</u> ID增大，<u>短按key2</u> ID减小，ID范围为0x00~0x07。<u>短按key1</u>两下后当前为0x04，此时再<u>长按key1</u>，箭头消失,此时参数已保存到flash，断电后重新启动即可。

<center class="half">
    <img src="E:\Robocon\图片\IMG_20240828_163645_edit_761896600206659.jpg" width="120"/>
    <img src="E:\Robocon\图片\IMG_20240828_163702_edit_761879471389995.jpg" width="120"/>
    <img src="E:\Robocon\图片\IMG_20240828_163719_edit_761863490621768.jpg" width="120"/>
    <img src="E:\Robocon\图片\IMG_20240828_163732_edit_761849112220728.jpg" width="120"/>
</center>












